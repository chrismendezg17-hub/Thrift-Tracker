<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>Scale Flipz Operations</title>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, viewport-fit=cover">
<meta name="theme-color" content="#0b0f14">
<link rel="manifest" href="manifest.webmanifest">
<link rel="icon" href="icon-192.png">
<link rel="apple-touch-icon" href="icon-192.png">

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js" crossorigin="anonymous"></script>
<script>
if (typeof Chart === 'undefined') {
  const s = document.createElement('script');
  s.src = 'https://unpkg.com/chart.js@4.4.1/dist/chart.umd.min.js';
  s.crossOrigin = 'anonymous';
  s.onload = () => { if (window.tryRenderAll) tryRenderAll(); };
  document.head.appendChild(s);
}
</script>

<style>
  :root{
    --bg:#0b0f14; --surface:#0f1622; --card:#111924; --line:#1f2a3a;
    --ink:#dbe7ff; --muted:#8aa0c7; --accent:#5bbcff;
    --good:#34d399; --warn:#fbbf24; --bad:#ef4444; --radius:14px;
    --pill-yellow:#6d530f; --pill-green:#1b6f52;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;color:var(--ink);
    background:linear-gradient(180deg,#071019,#0b0f14 30%,#0b0f14);
    font:15px/1.5 system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
    -webkit-font-smoothing:antialiased
  }
  header{
    position:sticky;top:0;z-index:5;padding:14px 16px;
    display:flex;align-items:center;justify-content:space-between;
    background:#0b0f14cc;border-bottom:1px solid var(--line);
    backdrop-filter:saturate(180%) blur(10px)
  }
  h1{margin:0;font-size:18px;letter-spacing:.3px}
  .wrap{max-width:1100px;margin:0 auto;padding:16px;padding-bottom:110px}
  .card{background:var(--card);border:1px solid var(--line);border-radius:var(--radius);padding:14px;margin:12px 0}
  .row{display:flex;gap:12px;flex-wrap:wrap}
  .row>*{flex:1 1 240px}
  .pill{display:inline-block;padding:3px 8px;border-radius:999px;background:var(--surface);border:1px solid var(--line);color:var(--muted);font-size:12px}
  .pill.await{border-color:var(--pill-yellow); color:#facc15}
  .pill.sold{border-color:var(--pill-green); color:#34d399}
  .muted{color:var(--muted)}
  .center{text-align:center}
  .big{font-size:28px;font-weight:600;margin:8px 0}
  label{display:flex;flex-direction:column;gap:6px;margin:6px 0;color:var(--muted);font-size:13px}
  input,select,textarea{background:var(--surface);border:1px solid #223146;color:var(--ink);padding:10px;border-radius:12px;outline:none}
  input:focus,select:focus,textarea:focus{border-color:var(--accent);box-shadow:0 0 0 2px #5bbcff33}
  button,.btn{appearance:none;background:#123048;border:1px solid #244e72;color:var(--ink);padding:10px 12px;border-radius:12px;cursor:pointer}
  .btn.primary{background:#0f2740;border-color:#285a85}
  .btn.ghost{background:transparent;border-color:#223146}
  .btn.good{border-color:#1b6f52}
  .btn.warn{border-color:#6d530f}
  .list{list-style:none;padding:0;margin:0}
  .list li{padding:10px;border-bottom:1px solid var(--line)}
  table{width:100%;border-collapse:collapse}
  th,td{padding:10px;border-bottom:1px solid var(--line);text-align:left}
  th{color:var(--muted);font-weight:600}
  .chart-box, .chart-pie { position: relative; height: 320px; }
  canvas { display:block; width:100% !important; height:100% !important; }
  nav.tabs{
    position:fixed;left:0;right:0;bottom:0;z-index:9;
    display:flex;gap:8px;justify-content:space-around;padding:10px 12px;
    padding-bottom:calc(10px + env(safe-area-inset-bottom));
    background:#0b0f14cc;border-top:1px solid var(--line);
    backdrop-filter:saturate(180%) blur(10px)
  }
  nav.tabs button{flex:1;background:var(--surface);border:1px solid #223146;border-radius:12px;padding:10px}
  nav.tabs button[aria-selected="true"]{border-color:var(--accent);box-shadow:0 0 0 2px #5bbcff22}
  section.view{display:none}
  section.view.active{display:block}
  .modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:#0008;z-index:20}
  .modal.active{display:flex}
  .modal .panel{width:min(700px,92vw);background:var(--card);border:1px solid var(--line);border-radius:16px;padding:16px}
  .modal .head{display:flex;align-items:center;justify-content:space-between;margin-bottom:10px}
  a,area,button,input,label,select,summary,textarea,[tabindex]{touch-action:manipulation}
</style>
</head>
<body>
  <header>
    <h1>Scale Flipz Operations</h1>
    <div class="row" style="flex:0 0 auto; gap:8px">
      <button class="btn ghost" id="btnImportEbay">Import eBay CSV</button>
      <button class="btn" id="btnSettings">Settings</button>
    </div>
  </header>

  <main class="wrap">
    <!-- HOME -->
    <section id="view-home" class="view active" role="tabpanel" aria-labelledby="tab-home">
      <div class="card center">
        <div class="pill">Dashboard</div>
        <div class="big" id="totalSales">$0.00</div>
        <div class="muted">Total Sales</div>
        <div class="row" style="margin-top:10px;align-items:center;justify-content:center">
          <label style="max-width:220px;margin-inline:auto">
            Period
            <select id="periodSelect">
              <option value="today">Today</option>
              <option value="week">This Week</option>
              <option value="month" selected>This Month</option>
              <option value="year">This Year</option>
            </select>
          </label>
        </div>
      </div>

      <div class="card">
        <h3 style="margin:6px 0">Sales</h3>
        <div class="chart-box">
          <canvas id="salesChart" aria-label="Sales over time"></canvas>
        </div>
      </div>

      <div class="card">
        <h3 style="margin:6px 0">Expenses</h3>
        <div class="row">
          <div style="flex:2 1 300px">
            <div class="chart-pie">
              <canvas id="expenseChart" aria-label="Expenses by category"></canvas>
            </div>
          </div>
          <div style="flex:1 1 240px">
            <ul class="list" id="expenseList"></ul>
          </div>
        </div>
      </div>

      <div class="card">
        <h3 style="margin:6px 0">Stores Performance</h3>
        <ul class="list" id="storesPerf"></ul>
      </div>
    </section>

    <!-- QUICK ADD -->
    <section id="view-quick" class="view" role="tabpanel" aria-labelledby="tab-quick">
      <div class="card">
        <h2>Quick Add</h2>
        <label>What do you want to add?
          <select id="qaType">
            <option value="item">Item</option>
            <option value="store">Store</option>
            <option value="expense">Expense</option>
            <option value="supply">Supply</option>
          </select>
        </label>
        <form id="qaForm"></form>
        <div class="row">
          <button class="btn primary" id="qaSave">Save</button>
          <button class="btn ghost" id="qaReset">Reset</button>
        </div>
      </div>
    </section>

    <!-- INVENTORY -->
    <section id="view-inventory" class="view" role="tabpanel" aria-labelledby="tab-inventory">
      <div class="card">
        <h2>Inventory</h2>
        <div class="row">
          <input id="invSearch" placeholder="Search by title or store‚Ä¶">
          <select id="invFilter">
            <option value="all">All</option>
            <option value="sold">Sold</option>
            <option value="unsold">Awaiting Sale</option>
          </select>
          <button class="btn" id="btnExport">Export Backup</button>
          <label class="btn" for="backupFile" style="display:inline-block;text-align:center;cursor:pointer">Import Backup</label>
          <input type="file" id="backupFile" accept="application/json" style="display:none">
        </div>
        <div class="card" style="overflow:auto">
          <table id="invTable">
            <thead>
              <tr>
                <th>Item</th><th>Store</th><th>Bought</th><th>Listed</th><th>Sold</th>
                <th>COG</th><th>Sold For</th><th>Fees</th><th>Shipping</th><th>Status</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- ROUTES -->
    <section id="view-routes" class="view" role="tabpanel" aria-labelledby="tab-routes">
      <div class="card">
        <h2>Routes</h2>
        <div class="row">
          <button class="btn" id="btnOrderRoute">Order Today‚Äôs Route (final stop closest to Home)</button>
          <button class="btn ghost" id="btnBulkImportStores">Bulk Import Stores</button>
        </div>
        <ul class="list" id="routeList"></ul>
      </div>
    </section>

    <!-- EXPENSES -->
    <section id="view-expenses" class="view" role="tabpanel" aria-labelledby="tab-expenses">
      <div class="card">
        <h2>Expenses Log</h2>
        <ul class="list" id="expenseLog"></ul>
      </div>
    </section>

    <!-- SUPPLIES -->
    <section id="view-supplies" class="view" role="tabpanel" aria-labelledby="tab-supplies">
      <div class="card">
        <div class="row" style="align-items:end">
          <h2 style="margin:0;flex:1 1 auto">Supplies</h2>
          <label style="max-width:300px">
            Quick Buy
            <select id="quickBuy">
              <option value="">Select a supply to buy‚Ä¶</option>
            </select>
          </label>
        </div>
        <div class="row">
          <label>Supply Name<input type="text" id="sup_name" placeholder="e.g. Poly mailers"></label>
          <label>Date Ordered<input type="date" id="sup_date" value=""></label>
          <label>Amount/Qty<input type="number" id="sup_amt" step="1" placeholder="e.g. 100"></label>
        </div>
        <div class="row">
          <label>Status
            <select id="sup_status">
              <option value="OK">In Stock</option>
              <option value="LOW">Low</option>
              <option value="OUT">Out</option>
            </select>
          </label>
          <label>eBay Link (hidden behind name)<input type="url" id="sup_url" placeholder="https://www.ebay.com/itm/..."></label>
        </div>
        <div class="row">
          <button class="btn primary" id="addSupply">Add Supply</button>
        </div>
      </div>

      <div class="card" style="overflow:auto">
        <table id="supTable">
          <thead>
            <tr><th>Supply</th><th>Date Ordered</th><th>Amount/Qty</th><th>Status</th><th>Actions</th></tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </section>
  </main>

  <!-- Tabs -->
  <nav class="tabs" role="tablist" aria-label="Bottom Navigation">
    <button id="tab-home" role="tab" aria-controls="view-home" aria-selected="true">Home</button>
    <button id="tab-quick" role="tab" aria-controls="view-quick">Quick Add</button>
    <button id="tab-inventory" role="tab" aria-controls="view-inventory">Inventory</button>
    <button id="tab-routes" role="tab" aria-controls="view-routes">Routes</button>
    <button id="tab-expenses" role="tab" aria-controls="view-expenses">Expenses</button>
    <button id="tab-supplies" role="tab" aria-controls="view-supplies">Supplies</button>
  </nav>

  <!-- Bulk Import Stores Modal -->
  <div class="modal" id="modalImportStores" aria-hidden="true">
    <div class="panel">
      <div class="head">
        <h3>Bulk Import Stores</h3>
        <button class="btn ghost" id="btnCloseImportStores">Close</button>
      </div>
      <p class="muted" style="margin-top:-6px">
        Paste Apple Maps links (one per line), or CSV with headers: <code>name,location,open,close,lat,lng</code>
      </p>
      <textarea id="bulkStoresInput" rows="10" placeholder="One URL per line, or CSV‚Ä¶"
        style="width:100%;background:var(--surface);border:1px solid #223146;color:var(--ink);padding:10px;border-radius:12px"></textarea>
      <div class="row" style="margin-top:10px">
        <button class="btn primary" id="btnDoImportStores">Import</button>
        <button class="btn" id="btnPreviewImportStores">Preview</button>
      </div>
      <div id="bulkStoresPreview" class="muted" style="margin-top:8px"></div>
    </div>
  </div>

  <!-- Settings Modal -->
  <div class="modal" id="modalSettings" aria-hidden="true">
    <div class="panel">
      <div class="head">
        <h3>Settings</h3>
        <button class="btn ghost" id="btnCloseSettings">Close</button>
      </div>
      <div class="row">
        <label>Home Latitude <input type="number" id="homeLat" step="0.000001" placeholder="e.g. 42.9634"></label>
        <label>Home Longitude <input type="number" id="homeLng" step="0.000001" placeholder="-85.6681"></label>
      </div>
      <div class="row">
        <label>Marketplace Fee Rate (%) <input type="number" id="feeRate" step="0.1" placeholder="13"></label>
        <label>Mileage Rate ($/mile) <input type="number" id="mileRate" step="0.01" placeholder="0.67"></label>
      </div>
      <div class="row">
        <button class="btn good" id="btnUseLocation">Use My Current Location</button>
        <button class="btn primary" id="btnSaveSettings2">Save Settings</button>
        <button class="btn warn" id="btnClearAll">Clear All Data</button>
      </div>
      <hr>
      <h4>Data Sources</h4>
      <div class="row" style="align-items:end">
        <div>
          <label>Import eBay CSV (orders/sales export)
            <input type="file" id="ebayCsv" accept=".csv">
          </label>
          <small class="muted">We parse item title, sold price, and date to feed the dashboard.</small>
          <label style="display:flex;align-items:center;gap:10px;margin-top:12px">
            <input type="checkbox" id="showToolbar"> Show eBay Sync Toolbar (advanced)
          </label>
          <small class="muted">Leave off to auto-hide once connected.</small>
        </div>
      </div>
    </div>
  </div>

<script>
/* ================= CORE UTILITIES ================= */
const $  = sel => document.querySelector(sel);
const $$ = sel => Array.from(document.querySelectorAll(sel));
const todayISO = () => { const d = new Date(); d.setHours(0,0,0,0); return d.toISOString().slice(0,10); };
const money = n => { const v = Number(n||0); return (v<0?'- $'+Math.abs(v).toFixed(2):'$'+v.toFixed(2)); };
const toast = msg => { try{ let t=document.getElementById('toast'); if(!t){ t=document.createElement('div'); t.id='toast';
  t.style.cssText='position:fixed;bottom:16px;left:50%;transform:translateX(-50%);background:#222;color:#fff;padding:8px 12px;border-radius:8px;z-index:9999;opacity:.95';
  document.body.appendChild(t);} t.textContent=msg; t.style.display='block'; setTimeout(()=>t.style.display='none',2000);}catch{} };
const safe = fn => { try{ fn(); } catch(e){ console.error(e); } };

function lsGet(key){ try{ return localStorage.getItem(key); } catch { return null; } }
function lsSet(key,val){ try{ localStorage.setItem(key,val); return true; } catch { return false; } }
function lsDel(key){ try{ localStorage.removeItem(key); } catch {} }
function readArrLS(key){ try{ const v=JSON.parse(lsGet(key)||'[]'); return Array.isArray(v)?v:[]; } catch { return []; } }
function uniqBy(arr, keyFn){ const seen=new Set(), out=[]; for(const x of arr){ const k=keyFn(x); if(seen.has(k)) continue; seen.add(k); out.push(x);} return out; }

const BACKEND_URL = 'https://thrift-tracker-worker.chrismendezg17.workers.dev';

/* ================= STORAGE ================= */
const mapTTSale = s => { const amt=Number(s.price ?? s.amount ?? 0); return {
  id:s.id || ('s_'+(s.orderId||'')), title:s.item || s.title || 'eBay order', date:(s.date||'').slice(0,10),
  price:amt, total:amt, store:s.store||'eBay', notes:s.notes||'', qty:s.qty??1, category:s.category||'Online'
};};
const mapTTExpense = e => ({ id:e.id||('e_'+(e.notes||'')), name:e.item||e.name||e.category||'Expense',
  category:e.category||'Other', amount:Number(e.cost??e.amount??0), notes:e.notes||'', date:(e.date||'').slice(0,10) });

const store = {
  get(key, def = []){
    try{
      const raw = lsGet(key);
      let out = raw ? JSON.parse(raw) : def;
      out = Array.isArray(out) || typeof out === 'object' ? out : def;
      if (key === 'sales') {
        const synced = readArrLS('tt-sales').map(mapTTSale);
        out = Array.isArray(out) ? out : [];
        out = uniqBy(out.concat(synced), x => [x.title, x.date, x.price].join('|'));
      }
      if (key === 'expenses') {
        const synced = readArrLS('tt-expenses').map(mapTTExpense);
        out = Array.isArray(out) ? out : [];
        out = uniqBy(out.concat(synced), x => [x.name, x.date, x.amount].join('|'));
      }
      return out;
    }catch{ return def; }
  },
  set(key,val){ lsSet(key, JSON.stringify(val)); },
  del(key){ lsDel(key); },
  all(){ return { items:this.get('items',[]), stores:this.get('stores',[]), sales:this.get('sales',[]), expenses:this.get('expenses',[]), supplies:this.get('supplies',[]) }; }
};

/* ================= SETTINGS ================= */
function getSettings(){
  const def = { home:{lat:null,lng:null}, flags:{showToolbar:false}, feeRate:0.13, mileRate:0.67 };
  const s = store.get('settings', def);
  return (!s || typeof s !== 'object')
    ? def
    : { home: (s.home&&typeof s.home==='object')?s.home:{lat:null,lng:null},
        flags:(s.flags&&typeof s.flags==='object')?s.flags:{showToolbar:false},
        feeRate:Number.isFinite(Number(s.feeRate))?Number(s.feeRate):0.13,
        mileRate:Number.isFinite(Number(s.mileRate))?Number(s.mileRate):0.67 };
}
function saveSettings(s){ store.set('settings', s); return getSettings(); }

/* ================= LABEL NORMALIZATION / CATEGORY REMAP ================= */
const HIDE_EXPENSE_CATEGORIES = new Set(['WITHDRAWAL']);
function prettifyLabel(s){
  return String(s || '')
    .replace(/_/g, ' ')
    .toLowerCase()
    .replace(/\b\w/g, c => c.toUpperCase());
}
function normalizeExpensesInPlace() {
  const raw = store.get('expenses', []);
  const out = [];
  for (const e of Array.isArray(raw) ? raw : []) {
    const amount = Number(e?.amount ?? e?.cost ?? 0) || 0;
    const date   = String(e?.date ?? '');
    const notes  = String(e?.notes ?? '');
    const name   = String(e?.name ?? e?.item ?? 'Expense');
    let catRaw   = String(e?.category ?? 'Other').toUpperCase();

    if (catRaw === 'WITHDRAWAL') continue;           // skip payouts to bank
    if (catRaw === 'PURCHASE') catRaw = 'COST OF GOODS';
    if (catRaw === 'SHIPPING_LABEL') catRaw = 'SHIPPING';
    if (catRaw === 'NON_SALE_CHARGE') catRaw = 'OTHER FEES';

    const category = prettifyLabel(catRaw);          // pretty for UI
    out.push({ ...e, amount, date, notes, name, category });
  }
  store.set('expenses', out);
}

/* ================= MODALS (ARIA-safe with inert) ================= */
function openModal(id){ const m=$(id); if(!m) return; m.inert=false; m.classList.add('active'); m.setAttribute('aria-hidden','false'); }
function closeModal(id){ const m=$(id); if(!m) return; document.activeElement?.blur?.(); m.classList.remove('active'); m.setAttribute('aria-hidden','true'); m.inert=true; }

/* ================= SETTINGS UI ================= */
function loadSettingsUI(){
  const s=getSettings();
  $('#homeLat').value = s.home.lat ?? '';
  $('#homeLng').value = s.home.lng ?? '';
  $('#feeRate').value = (Number(s.feeRate ?? 0.13) * 100).toString();
  $('#mileRate').value = (Number(s.mileRate ?? 0.67)).toString();
  const cb=$('#showToolbar'); if (cb) cb.checked = !!s.flags.showToolbar;
}
function openSettings(){ loadSettingsUI(); openModal('#modalSettings'); $('#homeLat')?.focus?.(); }
function closeSettings(){ closeModal('#modalSettings'); $('#btnSettings')?.focus?.(); }

$('#btnSettings').addEventListener('click', openSettings);
$('#btnCloseSettings').addEventListener('click', closeSettings);
window.addEventListener('DOMContentLoaded', ()=>{ $('#modalSettings')?.setAttribute('inert',''); $('#modalImportStores')?.setAttribute('inert',''); });

$('#btnSaveSettings2').addEventListener('click', ()=>{
  const latRaw = ($('#homeLat').value ?? '').toString().trim();
  const lngRaw = ($('#homeLng').value ?? '').toString().trim();
  const lat = latRaw === '' ? null : Number(latRaw);
  const lng = lngRaw === '' ? null : Number(lngRaw);

  const cur = getSettings();
  cur.home = { lat: Number.isFinite(lat)?lat:null, lng: Number.isFinite(lng)?lng:null };
  const cb=$('#showToolbar'); cur.flags = cur.flags || {}; cur.flags.showToolbar = cb ? !!cb.checked : false;

  const feePercent = Number($('#feeRate').value || 13);
  const mileRate   = Number($('#mileRate').value || 0.67);
  cur.feeRate  = Number.isFinite(feePercent) ? feePercent/100 : 0.13;
  cur.mileRate = Number.isFinite(mileRate)   ? mileRate : 0.67;

  const after = saveSettings(cur);
  const ok = (after.home.lat === cur.home.lat && after.home.lng === cur.home.lng);
  toast(ok ? 'Settings saved' : 'Could not save settings');

  closeSettings();
  renderRoutes();
  updateToolbarVisibility();
});

$('#btnClearAll').addEventListener('click',()=>{
  if(!confirm('Erase all local data? This cannot be undone.')) return;
  ['items','expenses','stores','sales','settings','tt-sales','tt-expenses','tt-ledger','supplies'].forEach(k=>store.del(k));
  tryRenderAll(); toast('All data cleared');
});
$('#btnUseLocation').addEventListener('click',()=>{
  if(!('geolocation' in navigator)){ toast('Geolocation not supported','bad'); return; }
  toast('Getting your location‚Ä¶');
  navigator.geolocation.getCurrentPosition(
    pos=>{
      const {latitude,longitude}=pos.coords||{};
      if(Number.isFinite(latitude)&&Number.isFinite(longitude)){
        $('#homeLat').value=latitude.toFixed(6);
        $('#homeLng').value=longitude.toFixed(6);
        const s=getSettings();
        s.home={lat:Number($('#homeLat').value),lng:Number($('#homeLng').value)};
        saveSettings(s);
        toast('Home location set');
        renderRoutes();
      } else { toast('Unable to read GPS','bad'); }
    },
    err=>{ const reasons={1:'Permission denied',2:'Position unavailable',3:'Timeout'}; toast(`Location error: ${reasons[err.code]||'Unknown'}`,'bad'); },
    { enableHighAccuracy:true, timeout:10000, maximumAge:600000 }
  );
});

/* ================= TABS ================= */
function activateView(id){
  $$('.view').forEach(v=>v.classList.remove('active'));
  $('#'+id).classList.add('active');
  $$('nav.tabs [role="tab"]').forEach(b=>b.setAttribute('aria-selected','false'));
  $(`[aria-controls="${id}"]`).setAttribute('aria-selected','true');
}
$$('nav.tabs [role="tab"]').forEach(btn=>btn.addEventListener('click',()=>activateView(btn.getAttribute('aria-controls'))));

/* ================= QUICK ADD ================= */
const qaType=$('#qaType'), qaForm=$('#qaForm');
function renderQA(){
  const t=qaType.value;
  if(t==='item'){ qaForm.innerHTML=`
    <div class="row">
      <label>Date<input type="date" id="i_date" value="${todayISO()}"></label>
      <label>Item Title<input type="text" id="i_title" placeholder="Sony DVD player"></label>
      <label>Cost of Goods ($)<input type="number" step="0.01" id="i_price" placeholder="4.99"></label>
    </div>
    <div class="row">
      <label>Store<input type="text" id="i_store" placeholder="Goodwill Outlet"></label>
      <label>eBay Sell-through Rate (%)<input type="number" step="0.1" id="i_str" placeholder="e.g. 65"></label>
    </div>
    <label>Notes<textarea id="i_notes" rows="2" placeholder="Condition, model, comps..."></textarea></label>
    <details class="card" style="margin-top:10px"><summary class="muted">Optional sale fields</summary>
      <div class="row">
        <label>Listed Date<input type="date" id="i_listed"></label>
        <label>Sold Date<input type="date" id="i_sold"></label>
        <label>Sold Price<input type="number" step="0.01" id="i_soldfor"></label>
        <label>Shipping Cost<input type="number" step="0.01" id="i_ship" placeholder="e.g. 8.95"></label>
      </div>
    </details>`; }
  else if(t==='store'){ qaForm.innerHTML=`
    <div class="row">
      <label>Store Name<input type="text" id="s_name" placeholder="New 2 You"></label>
      <label>Location (address/free text)<input type="text" id="s_loc" placeholder="123 Main St, Grand Rapids"></label>
    </div>
    <div class="row">
      <label>Open Time<input type="time" id="s_open"></label>
      <label>Close Time<input type="time" id="s_close"></label>
    </div>
    <div class="row">
      <label>Latitude (optional)<input type="number" step="0.000001" id="s_lat" placeholder="42.9634"></label>
      <label>Longitude (optional)<input type="number" step="0.000001" id="s_lng" placeholder="-85.6681"></label>
    </div>
    <label>Notes<textarea id="s_notes" rows="2"></textarea></label>`; }
  else if(t==='supply'){ qaForm.innerHTML=`
    <div class="row">
      <label>Supply Name<input type="text" id="qa_sup_name" placeholder="Poly mailers"></label>
      <label>Date Ordered<input type="date" id="qa_sup_date" value="${todayISO()}"></label>
      <label>Amount/Qty<input type="number" id="qa_sup_amt" step="1" placeholder="100"></label>
    </div>
    <div class="row">
      <label>Status
        <select id="qa_sup_status"><option value="OK">In Stock</option><option value="LOW">Low</option><option value="OUT">Out</option></select>
      </label>
      <label>eBay Link<input type="url" id="qa_sup_url" placeholder="https://www.ebay.com/itm/..."></label>
    </div>`; }
  else { qaForm.innerHTML=`
    <div class="row">
      <label>Expense Name<input type="text" id="e_name" placeholder="Poly mailers"></label>
      <label>Category
        <select id="e_cat"><option>Cost of Goods</option><option>Shipping</option><option>eBay Fees</option>
          <option>Supplies</option><option>Equipment</option><option>Gas</option><option>Mileage</option><option>Other</option></select>
      </label>
      <label>Amount ($)<input type="number" id="e_amt" step="0.01" placeholder="12.50"></label>
    </div>
    <label>Notes<textarea id="e_notes" rows="2"></textarea></label>
    <label>Date<input type="date" id="e_date" value="${todayISO()}"></label>`; }
}
qaType.addEventListener('change',renderQA); renderQA();

$('#qaSave').addEventListener('click', ()=>{
  const data=store.all();

  if(qaType.value==='item'){
    const id = 'i_' + Date.now();
    const title = $('#i_title').value.trim();
    const date  = $('#i_date').value || todayISO();
    const price = Number($('#i_price').value || 0);
    const storeName = $('#i_store').value.trim();

    const soldDate = $('#i_sold').value || null;
    const soldFor  = $('#i_soldfor').value ? Number($('#i_soldfor').value) : null;
    const shipCost = $('#i_ship') ? Number($('#i_ship').value || 0) : 0;

    const it = {
      id, title, date, price, store: storeName,
      str: Number($('#i_str').value || 0),
      notes: $('#i_notes').value.trim(),
      listed_date: $('#i_listed').value || null,
      sold_date: soldDate,
      sold_for: soldFor
    };

    // Save item
    data.items.push(it);
    store.set('items', data.items);

    // 1) COGS
    const cogExpense = {
      id: 'cog_' + id,
      name: title || 'Cost of Goods',
      category: 'Cost Of Goods',
      amount: price,
      notes: storeName ? `COGS for ${title} @ ${storeName}` : `COGS for ${title}`,
      date
    };
    let ex = data.expenses.filter(e => e.id !== cogExpense.id);
    ex.push(cogExpense);

    // 2) If sold: create sale + estimated fees + optional shipping
    if (soldDate && Number.isFinite(soldFor)) {
      // sale
      const saleRec = {
        id: 'sale_' + id,
        title: title || 'Manual sale',
        date: soldDate,
        total: soldFor,
        price: soldFor,
        store: 'eBay',
        category: 'Online',
        notes: `Linked to item ${id}`
      };
      const salesNo = store.get('sales', []).filter(s=>s.id!==saleRec.id); salesNo.push(saleRec);
      store.set('sales', salesNo);

      // fees (est.)
      const feeRate = Number(getSettings()?.feeRate ?? 0.13);
      const estFees = Math.max(0, soldFor * feeRate);
      const feeExp = {
        id: 'fees_' + id,
        name: 'eBay Fees (est.)',
        category: 'eBay Fees',
        amount: estFees,
        notes: `~${(feeRate*100).toFixed(1)}% on ${money(soldFor)} (item ${id})`,
        date: soldDate
      };
      ex = ex.filter(e => e.id !== feeExp.id); ex.push(feeExp);

      // shipping (optional)
      if (Number.isFinite(shipCost) && shipCost > 0) {
        const shipExp = {
          id: 'ship_' + id,
          name: 'Shipping Label',
          category: 'Shipping',
          amount: shipCost,
          notes: `Shipping for ${title} (item ${id})`,
          date: soldDate
        };
        ex = ex.filter(e => e.id !== shipExp.id); ex.push(shipExp);
      }
    }

    store.set('expenses', ex);
    normalizeExpensesInPlace();
    toast(soldDate ? 'Item + sale + expenses saved' : 'Item saved (+ COGS)');
  }

  else if(qaType.value==='store'){
    const s={id:'s_'+Date.now(),name:$('#s_name').value.trim(),location:$('#s_loc').value.trim(),
      open:$('#s_open').value||null,close:$('#s_close').value||null,
      lat:$('#s_lat').value?Number($('#s_lat').value):null,lng:$('#s_lng').value?Number($('#s_lng').value):null,
      notes:$('#s_notes').value.trim()};
    data.stores.push(s); store.set('stores',data.stores); toast('Store saved');
  }

  else if(qaType.value==='supply'){
    const sup = {
      id: 'sup_' + Date.now(),
      name: $('#qa_sup_name').value.trim(),
      date: $('#qa_sup_date').value || todayISO(),
      amount: Number($('#qa_sup_amt').value || 0),
      status: $('#qa_sup_status').value || 'OK',
      url: ($('#qa_sup_url').value || '').trim()
    };
    const list = store.get('supplies', []);
    list.push(sup);
    store.set('supplies', list);
    toast('Supply saved');
  }

  else {
    const e={id:'e_'+Date.now(),name:$('#e_name').value.trim(),category:$('#e_cat').value,
      amount:Number($('#e_amt').value||0),notes:$('#e_notes').value.trim(),date:$('#e_date').value||todayISO()};
    data.expenses.push(e); store.set('expenses',data.expenses); normalizeExpensesInPlace(); toast('Expense saved');
  }
  tryRenderAll();
});
$('#qaReset').addEventListener('click',renderQA);

/* ================= INVENTORY / EXPENSES ================= */
function buildLinkedExpenseMaps(){
  const ex = store.get('expenses', []);
  const fees = new Map(); const ship = new Map(); const cogs = new Map();
  for (const e of ex){
    if (typeof e.id === 'string' && e.id.startsWith('fees_i_')) fees.set(e.id.slice(5), Number(e.amount||0));
    if (typeof e.id === 'string' && e.id.startsWith('ship_i_')) ship.set(e.id.slice(5), Number(e.amount||0));
    if (typeof e.id === 'string' && e.id.startsWith('cog_i_'))  cogs.set(e.id.slice(4),  Number(e.amount||0));
  }
  return { fees, ship, cogs };
}
function renderInventory(){
  const data=store.all(), q=($('#invSearch').value||'').toLowerCase().trim(), f=$('#invFilter').value, tbody=$('#invTable tbody');
  const soldTitles=new Set(data.sales.map(x=>(x.title||'').toLowerCase().trim()));
  const { fees, ship, cogs } = buildLinkedExpenseMaps();

  let items=data.items.map(i=>{
    const sold = (i.sold_for && i.sold_date) || soldTitles.has((i.title||'').toLowerCase().trim());
    return {
      ...i,
      _sold: !!sold,
      _fees: fees.get(i.id)||0,
      _ship: ship.get(i.id)||0,
      _cog:  cogs.get(i.id) ?? Number(i.price||0)
    };
  });

  if(q) items=items.filter(i=>(i.title||'').toLowerCase().includes(q)||(i.store||'').toLowerCase().includes(q));
  if(f==='sold') items=items.filter(i=>i._sold);
  if(f==='unsold') items=items.filter(i=>!i._sold);

  tbody.innerHTML=items.map(i=>`
    <tr>
      <td>${i.title||''}</td>
      <td>${i.store||''}</td>
      <td>${i.date||''}</td>
      <td>${i.listed_date||''}</td>
      <td>${i.sold_date||''}</td>
      <td>${money(i._cog)}</td>
      <td>${i.sold_for!=null?money(i.sold_for):''}</td>
      <td>${i._fees?money(i._fees):''}</td>
      <td>${i._ship?money(i._ship):''}</td>
      <td>${i._sold?'<span class="pill sold">Sold</span>':'<span class="pill await">Awaiting Sale</span>'}</td>
    </tr>`).join('');
}
$('#invSearch').addEventListener('input',renderInventory);
$('#invFilter').addEventListener('change',renderInventory);

function renderExpenses(){
  try {
    // Ensure every expense has an id so edit/delete works
    let ex = store.get('expenses', []);
    let mutated = false;
    ex = (Array.isArray(ex) ? ex : []).map(e => {
      if (!e.id) { e.id = 'e_' + Date.now().toString(36) + Math.random().toString(36).slice(2); mutated = true; }
      return {
        id: e.id,
        name: String(e?.name ?? 'Expense'),
        category: String(e?.category ?? 'Other'),
        amount: Number(e?.amount ?? e?.cost ?? 0) || 0,
        notes: String(e?.notes ?? ''),
        date: String(e?.date ?? '')
      };
    });
    if (mutated) store.set('expenses', ex); // persist new ids

    const html = ex
      .slice()
      .sort((a,b) => (b.date||'').localeCompare(a.date||''))
      .map(e => `
        <li data-id="${e.id}">
          <div><strong>${e.name}</strong> ‚Äî ${money(e.amount)} <span class="muted">(${e.category})</span><br>
            <small class="muted">${e.date}${e.notes ? ' ‚Ä¢ ' + e.notes : ''}</small>
          </div>
          <div class="row" style="gap:6px;margin-top:6px;flex-wrap:wrap">
            <button class="btn ghost exp-edit" style="padding:6px 10px">‚úèÔ∏è Edit</button>
            <button class="btn warn exp-del"  style="padding:6px 10px">üóëÔ∏è Delete</button>
          </div>
        </li>
      `).join('');

    const ul = document.getElementById('expenseLog');
    if (ul) ul.innerHTML = html || '<li class="muted">No expenses yet.</li>';
  } catch (err) {
    console.error('renderExpenses failed:', err);
    const ul = document.getElementById('expenseLog');
    if (ul) ul.innerHTML = '<li class="muted">No expenses yet.</li>';
  }
}


/* ================= SUPPLIES ================= */
function renderSupplies(){
  const list = store.get('supplies', []);
  const qb = $('#quickBuy');
  qb.innerHTML = '<option value="">Select a supply to buy‚Ä¶</option>' +
    list.filter(s=>s.url).map(s=>`<option value="${encodeURIComponent(s.url)}">${s.name}</option>`).join('');
  qb.onchange = () => {
    const val = qb.value; if (!val) return;
    const url = decodeURIComponent(val);
    window.open(url, '_blank','noopener');
    qb.value = '';
  };

  const tbody = $('#supTable tbody');
  tbody.innerHTML = list.map(s=>`
    <tr data-id="${s.id}">
      <td>${s.url?`<a href="${s.url}" target="_blank" rel="noopener">${s.name||''}</a>`:(s.name||'')}</td>
      <td>${s.date||''}</td>
      <td>${Number.isFinite(Number(s.amount))?s.amount:''}</td>
      <td>
        <select class="sup-status">
          <option value="OK"${s.status==='OK'?' selected':''}>In Stock</option>
          <option value="LOW"${s.status==='LOW'?' selected':''}>Low</option>
          <option value="OUT"${s.status==='OUT'?' selected':''}>Out</option>
        </select>
      </td>
      <td><button class="btn ghost sup-del">Delete</button></td>
    </tr>
  `).join('');

  tbody.querySelectorAll('select.sup-status').forEach(sel=>{
    sel.addEventListener('change', e=>{
      const tr = e.target.closest('tr[data-id]'); const id = tr.getAttribute('data-id');
      const arr = store.get('supplies', []);
      const idx = arr.findIndex(x=>x.id===id); if (idx<0) return;
      arr[idx].status = e.target.value;
      store.set('supplies', arr);
      toast('Supply updated');
    });
  });
  tbody.querySelectorAll('button.sup-del').forEach(btn=>{
    btn.addEventListener('click', e=>{
      const tr = e.target.closest('tr[data-id]'); const id = tr.getAttribute('data-id');
      if (!confirm('Delete this supply?')) return;
      const arr = store.get('supplies', []).filter(x=>x.id!==id);
      store.set('supplies', arr);
      renderSupplies();
      toast('Supply removed');
    });
  });
}
$('#addSupply').addEventListener('click', ()=>{
  const sup = {
    id: 'sup_' + Date.now(),
    name: $('#sup_name').value.trim(),
    date: $('#sup_date').value || todayISO(),
    amount: Number($('#sup_amt').value || 0),
    status: $('#sup_status').value || 'OK',
    url: ($('#sup_url').value || '').trim()
  };
  const list = store.get('supplies', []);
  list.push(sup);
  store.set('supplies', list);
  $('#sup_name').value = ''; $('#sup_amt').value = ''; $('#sup_url').value = '';
  renderSupplies();
  toast('Supply added');
});

/* ================= ROUTES ================= */
function haversine(lat1,lon1,lat2,lon2){
  const r=n=>n*Math.PI/180,R=6371,dLat=r(lat2-lat1),dLon=r(lon2-lon1);
  const a=Math.sin(dLat/2)**2+Math.cos(r(lat1))*Math.cos(r(lat2))*Math.sin(dLon/2)**2;
  return R*2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a));
}
function renderRoutes(){
  const stores = store.get('stores', []);
  let mutated=false;
  for(const st of stores){ if(!st.id){ st.id='s_'+Math.random().toString(36).slice(2); mutated=true; } }
  if (mutated) store.set('stores', stores);

  $('#routeList').innerHTML = stores.map(s=>{
    const maps = (Number.isFinite(s.lat)&&Number.isFinite(s.lng)) ? `https://maps.apple.com/?daddr=${s.lat},${s.lng}` : '';
    const loc  = s.location ? `<small class="muted">${s.location}</small><br>` : '';
    const hours= (s.open||s.close) ? `<span class="muted">${s.open||''}${(s.open||s.close)?'‚Äì':''}${s.close||''}</span>` : '';
    return `
      <li data-id="${s.id}">
        <strong>${s.name||''}</strong> ${hours ? hours : ''}<br>
        ${loc}
        <div class="row" style="gap:6px;margin-top:6px;flex-wrap:wrap">
          ${maps ? `<a class="btn ghost" target="_blank" rel="noopener" href="${maps}">Open in Maps</a>` : ''}
          <button class="btn ghost route-edit"  style="padding:6px 10px">‚úèÔ∏è Edit</button>
          <button class="btn warn  route-del"   style="padding:6px 10px">üóëÔ∏è Delete</button>
        </div>
      </li>
    `;
  }).join('') || '<li class="muted">No stores yet. Add some in Quick Add ‚Üí Store, or use ‚ÄúBulk Import Stores‚Äù.</li>';
}
function totalRouteMiles(home, stores){
  let miles = 0;
  let prev = { lat: home.lat, lng: home.lng };
  for (const s of stores) {
    if (Number.isFinite(s.lat) && Number.isFinite(s.lng)) {
      miles += haversine(prev.lat, prev.lng, s.lat, s.lng) * 0.621371;
      prev = { lat: s.lat, lng: s.lng };
    }
  }
  return miles;
}
function orderRouteWithFinalNearestHome(){
  const s = getSettings();
  const home = s?.home || {};
  if (!Number.isFinite(home.lat) || !Number.isFinite(home.lng)) { toast('Set your Home location in Settings first','bad'); return; }

  const stores = store.get('stores', []).slice();
  if (!stores.length) { toast('No stores to reorder'); return; }

  stores.sort((a,b)=>(a.open||'99:99').localeCompare(b.open||'99:99'));
  const withDists = stores.map((st,i)=>{
    const lat = Number(st.lat), lng = Number(st.lng);
    const d = (Number.isFinite(lat)&&Number.isFinite(lng)) ? haversine(home.lat, home.lng, lat, lng) : Infinity;
    return { i, d, name: st.name || '' };
  });
  const best = withDists.reduce((best,c)=> c.d < best.d ? c : best, {i:-1,d:Infinity,name:''});
  if (best.i >= 0 && isFinite(best.d)) {
    const [closest] = stores.splice(best.i, 1);
    stores.push(closest);
    store.set('stores', stores);
    renderRoutes();
    toast(`Final stop set to: ${closest.name || 'Store'}`);

    const miles = totalRouteMiles(home, stores);
    const rate  = Number(s?.mileRate ?? 0.67);
    const amt   = Math.round(miles * rate * 100) / 100;

    const today = todayISO();
    const mileExp = {
      id: 'mile_' + today,
      name: 'Mileage',
      category: 'Mileage',
      amount: amt,
      notes: `Auto from route: ${miles.toFixed(1)} mi @ ${money(rate)}/mi`,
      date: today
    };
    const curEx = store.get('expenses', []);
    const exNo = curEx.filter(e => e.id !== mileExp.id);
    exNo.push(mileExp);
    store.set('expenses', exNo);
    normalizeExpensesInPlace();
    renderExpenses();
  } else {
    toast('Could not compute distances ‚Äî check store lat/lng','bad');
  }
}
document.getElementById('btnOrderRoute').addEventListener('click', orderRouteWithFinalNearestHome);
document.getElementById('routeList').addEventListener('click', (e) => {
  const li = e.target.closest('li[data-id]'); if (!li) return;
  const id = li.getAttribute('data-id');
  const stores = store.get('stores', []);
  const idx = stores.findIndex(s=>s.id===id); if (idx < 0) return;

  if (e.target.closest('.route-edit')) {
    const st = stores[idx];
    const name = prompt('Store name:', st.name ?? '') ?? st.name;
    const location = prompt('Location/address:', st.location ?? '') ?? st.location;
    const open = prompt('Open time (HH:MM, optional):', st.open ?? '') ?? st.open;
    const close = prompt('Close time (HH:MM, optional):', st.close ?? '') ?? st.close;
    const latIn = prompt('Latitude:', st.lat ?? '') ?? (st.lat ?? '');
    const lngIn = prompt('Longitude:', st.lng ?? '') ?? (st.lng ?? '');
    const lat = latIn === '' ? null : Number(latIn);
    const lng = lngIn === '' ? null : Number(lngIn);
    stores[idx] = { ...st, name, location, open:open||null, close:close||null,
      lat:Number.isFinite(lat)?lat:null, lng:Number.isFinite(lng)?lng:null };
    store.set('stores', stores);
    toast('Store updated'); renderRoutes(); return;
  }
  if (e.target.closest('.route-del')) {
    if (confirm('Delete this store?')) {
      stores.splice(idx, 1);
      store.set('stores', stores);
      toast('Store removed'); renderRoutes();
    }
  }
});

/* ================= BULK IMPORT STORES (URLs or CSV) ================= */
function parseCsv(text){ const lines=text.replace(/\r/g,'').split('\n').filter(l=>l.trim().length); if(!lines.length) return [];
  const headers=lines[0].split(',').map(h=>h.trim().replace(/^"|"$/g,'')); const split=line=>{const out=[];let cur='',q=false;
    for(let i=0;i<line.length;i++){const c=line[i]; if(c==='"' && (i===0||line[i-1]!=='\\')) q=!q; else if(c===','&&!q){out.push(cur);cur='';continue;} cur+=c;}
    out.push(cur); return out.map(x=>x.trim().replace(/^"|"$/g,'')); };
  return lines.slice(1).map(l=>{const cells=split(l),o={}; headers.forEach((h,i)=>o[h]=cells[i]); return o;}); }
function parseCsvLoose(text){ const lines=text.replace(/\r/g,'').split('\n').filter(l=>l.trim()); if(!lines.length) return [];
  const headers = lines[0].split(',').map(h=>h.trim());
  return lines.slice(1).map(l=>{ const cells=l.split(','); const o={}; headers.forEach((h,i)=>o[h]=cells[i]??''); return o; });
}
function parseAppleMapsUrl(line){
  try{
    const s=line.trim(); if(!/^https?:\/\/(maps\.apple\.com)(\/|$)/i.test(s)) return null;
    const u=new URL(s), p=u.searchParams;
    const name=p.get('q')||p.get('name')||''; const address=p.get('address')||'';
    let coord=p.get('ll')||p.get('sll')||p.get('daddr')||p.get('coordinate')||'';
    const m=coord && coord.match(/-?\d+(\.\d+)?\s*,\s*-?\d+(\.\d+)?/);
    let lat=null,lng=null; if(m){ const [a,b]=m[0].split(',').map(Number); if(Number.isFinite(a)&&Number.isFinite(b)){lat=a;lng=b;} }
    const placeName=decodeURIComponent(name||address).trim()||'(Place)'; const location=decodeURIComponent(address).trim();
    return { id:'s_'+Math.random().toString(36).slice(2), name:placeName, location, open:null, close:null,
      lat:Number.isFinite(lat)?lat:null, lng:Number.isFinite(lng)?lng:null, notes:'' };
  }catch{ return null; }
}
function parseStoreRow(row){
  const pick=(o,ks)=>{for(const k of ks){ if(o[k]!=null && String(o[k]).trim()!=='') return String(o[k]).trim(); } return '';};
  const name = pick(row, ['name','store','title']);
  const location = pick(row, ['location','address','addr']);
  const open = pick(row, ['open','opens','start','open_time']);
  const close = pick(row, ['close','closes','end','close_time']);
  const latS = pick(row, ['lat','latitude']);
  const lngS = pick(row, ['lng','lon','long','longitude']);
  const lat = latS ? Number(latS) : null; const lng = lngS ? Number(lngS) : null;
  return { id:'s_'+Math.random().toString(36).slice(2), name:name||'(Store)', location, open:open||null, close:close||null,
           lat:Number.isFinite(lat)?lat:null, lng:Number.isFinite(lng)?lng:null, notes:'' };
}
function dedupeStores(arr, existing){
  const out=[], seen=new Set();
  function key(s){ return (Number.isFinite(s.lat)&&Number.isFinite(s.lng)) ? `geo:${s.lat.toFixed(5)},${s.lng.toFixed(5)}`
    : `nl:${(s.name||'').toLowerCase().trim()}|${(s.location||'').toLowerCase().trim()}`; }
  const all=(existing||[]).concat(arr);
  for(const s of all){ const k=key(s); if(seen.has(k)) continue; seen.add(k); out.push(s); }
  return out;
}
(function initBulkImportStores(){
  const modal=$('#modalImportStores'), openBtn=$('#btnBulkImportStores'), closeBtn=$('#btnCloseImportStores');
  const doBtn=$('#btnDoImportStores'), prevBtn=$('#btnPreviewImportStores'), input=$('#bulkStoresInput'), preview=$('#bulkStoresPreview');
  if(!modal||!openBtn) return;
  function show(){ openModal('#modalImportStores'); input.focus(); }
  function hide(){ closeModal('#modalImportStores'); preview.textContent=''; $('#btnBulkImportStores').focus(); }
  openBtn.addEventListener('click', show);
  closeBtn.addEventListener('click', hide);

  function parseBulk(text){
    const lines=text.split('\n').map(s=>s.trim()).filter(Boolean);
    const first = lines[0] || '';
    const isLikelyUrl = /^https?:\/\//i.test(first);
    const looksCsvHeader  = /^(name|store|title|location|address|lat|lng)\s*,/i.test(first);
    const looksCsv        = !isLikelyUrl && (looksCsvHeader || (lines.length > 1 && first.includes(',')));
    let parsed=[];
    if(looksCsv){ const rows=parseCsvLoose(text); parsed=rows.map(parseStoreRow); }
    else { parsed = lines.map(l=>parseAppleMapsUrl(l) || {__skip:true}).filter(o=>!o.__skip); }
    return parsed;
  }
  prevBtn.addEventListener('click', ()=>{
    const arr=parseBulk(input.value);
    const missing=arr.filter(s=>!(Number.isFinite(s.lat)&&Number.isFinite(s.lng)) && (s.name||s.location)).length;
    preview.textContent = arr.length ? `Will import ${arr.length} store${arr.length===1?'':'s'}` + (missing?` ‚Ä¢ ${missing} need coords`:'') : 'Nothing detected.';
  });
  doBtn.addEventListener('click', ()=>{
    const arr=parseBulk(input.value); if(!arr.length){ toast('Nothing to import','bad'); return; }
    const all=store.all(); const merged=dedupeStores(arr, all.stores);
    store.set('stores', merged); toast(`Imported ${arr.length} store${arr.length===1?'':'s'}`); renderRoutes(); hide();
  });
})();

/* ================= DASHBOARD ================= */
function groupSales(period){
  const sales=store.get('sales',[]), now=new Date(), fmt=d=>d.toISOString().slice(0,10);
  const startOfWeek=d=>{const t=new Date(d); const w=(t.getDay()+6)%7; t.setDate(t.getDate()-w); t.setHours(0,0,0,0); return t;};
  const startOfMonth=d=>new Date(d.getFullYear(), d.getMonth(), 1);
  let labels=[], data=[];
  if(period==='today'){ labels=[...Array(24)].map((_,h)=>h+":00"); const map=new Array(24).fill(0);
    sales.forEach(s=>{if(!s.date)return; const dt=new Date(s.date); if(fmt(dt)===fmt(now)) map[dt.getHours()]+=Number((s.total ?? s.price) || 0)}); data=map; }
  else if(period==='week'){ const start=startOfWeek(now); labels=['Mon','Tue','Wed','Thu','Fri','Sat','Sun']; const map=new Array(7).fill(0);
    sales.forEach(s=>{if(!s.date)return; const dt=new Date(s.date); if(dt>=start){const i=(dt.getDay()+6)%7; map[i]+=Number((s.total ?? s.price) || 0)}}); data=map; }
  else if(period==='month'){ const start=startOfMonth(now), days=new Date(now.getFullYear(),now.getMonth()+1,0).getDate();
    labels=[...Array(days)].map((_,i)=>String(i+1)); const map=new Array(days).fill(0);
    sales.forEach(s=>{if(!s.date)return; const dt=new Date(s.date); if(dt>=start&&dt.getMonth()===now.getMonth()) map[dt.getDate()-1]+=Number((s.total ?? s.price) || 0)}); data=map; }
  else { labels=['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec']; const map=new Array(12).fill(0);
    sales.forEach(s=>{if(!s.date)return; const dt=new Date(s.date); if(dt.getFullYear()===now.getFullYear()) map[dt.getMonth()]+=Number((s.total ?? s.price) || 0)}); data=map; }
  return {labels,data};
}
function renderTotalSales() {
  try {
    const sel = document.querySelector('#periodSelect');
    const period = sel && sel.value ? sel.value : 'month';
    const gs = typeof groupSales === 'function' ? groupSales(period) : { data: [] };
    const arr = (gs && Array.isArray(gs.data)) ? gs.data : [];
    const total = arr.reduce((a, b) => a + (Number.isFinite(Number(b)) ? Number(b) : 0), 0);
    const el = document.getElementById('totalSales');
    if (el) el.textContent = money(total);
  } catch (e) {
    console.error('renderTotalSales failed:', e);
    const el = document.getElementById('totalSales');
    if (el) el.textContent = '$0.00';
  }
}
function renderSalesChart(){
  const el=$('#salesChart'); if(!el) return;
  if(typeof Chart==='undefined'){ console.warn('Chart.js not loaded; skipping sales chart'); return; }
  const { labels, data } = groupSales($('#periodSelect').value || 'month');
  if (window.__charts && window.__charts.sales){ window.__charts.sales.destroy(); }
  const ctx=el.getContext('2d'); window.__charts=window.__charts||{};
  window.__charts.sales=new Chart(ctx,{ type:'bar', data:{labels, datasets:[{label:'Sales', data}]},
    options:{ responsive:true, maintainAspectRatio:false, resizeDelay:200, animation:false,
      scales:{ y:{ beginAtZero:true } } }});
}
$('#periodSelect').addEventListener('change', ()=>{ safe(renderSalesChart); safe(renderTotalSales); });

function renderExpensePie(){
  const el = document.getElementById('expenseChart');
  if (!el) return;

  const by = {};
  for (const e of store.get('expenses', [])) {
    const rawCat = String(e?.category ?? 'Other').toUpperCase();
    if (HIDE_EXPENSE_CATEGORIES.has(rawCat)) continue;
    const k = rawCat;
    by[k] = (by[k] || 0) + Number(e?.amount ?? e?.cost ?? 0) || 0;
  }
  const entries = Object.entries(by).sort((a,b) => b[1] - a[1]);
  const labelsPretty = entries.map(([k]) => prettifyLabel(k));
  const values = entries.map(([,v]) => v);

  const list = document.getElementById('expenseList');
  if (list) {
    list.innerHTML = entries.length
      ? entries.map(([k,v]) => `<li><strong>${prettifyLabel(k)}</strong> ‚Äî ${money(v)}</li>`).join('')
      : '<li class="muted">No expenses yet.</li>';
  }

  if (typeof Chart === 'undefined') { console.warn('Chart.js not loaded; skipping expense chart'); return; }
  if (window.__charts && window.__charts.expense) { window.__charts.expense.destroy(); }

  const ctx = el.getContext('2d');
  window.__charts = window.__charts || {};
  window.__charts.expense = new Chart(ctx, {
    type: 'pie',
    data: { labels: labelsPretty, datasets: [{ data: values }] },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: { legend: { labels: { font: { size: 12 } } } }
    }
  });
}
function renderStoresPerf(){
  const items=store.get('items',[]), sales=store.get('sales',[]);
  const soldByTitle={}; sales.forEach(s=>{ const t=(s.title||'').toLowerCase().trim(); soldByTitle[t]=(soldByTitle[t]||0)+Number((s.total ?? s.price) || 0); });
  const perf={}; items.forEach(it=>{ const k=it.store||''; if(!perf[k]) perf[k]={cogs:0,count:0,sold:0};
    perf[k].cogs+=Number(it.price||0); perf[k].count+=1; const key=(it.title||'').toLowerCase().trim(); if(soldByTitle[key]) perf[k].sold+=soldByTitle[key]; });
  const rows=Object.entries(perf).sort((a,b)=>b[1].sold-a[1].sold);
  $('#storesPerf').innerHTML = rows.map(([name,p])=>`
    <li><strong>${name||'(no store set)'}</strong><br>
      <small class="muted">COGS: ${money(p.cogs)} ‚Ä¢ Items: ${p.count} ‚Ä¢ Sold: ${money(p.sold)}</small>
    </li>`).join('') || '<li class="muted">No stores yet. Add some in Quick Add ‚Üí Store.</li>';
}

/* ================= CSV IMPORT + BACKUP ================= */
function pickNumber(o,ks){ for(const k of ks){ if(k in o && o[k]!=='' && o[k]!=null){const v=String(o[k]).replace(/[^0-9.\-]/g,''); if(v!==''&&!Number.isNaN(Number(v))) return Number(v);} } return null; }
function pickDate(o,ks){ for(const k of ks){ if(k in o && o[k]){const d=new Date(o[k]); if(!isNaN(d)) return d.toISOString();} } return null; }
function pickText(o,ks){ for(const k of ks){ if(k in o && o[k]) return String(o[k]); } return ''; }
function importEbayCsv(file){
  const r=new FileReader();
  r.onload=()=>{
    const rows=parseCsv(r.result);
    const sales=rows.map(row=>({
      title:pickText(row,['Item Title','Title','Item title','Item']),
      total:pickNumber(row,['Total Price','Item Total','Sold For','Total','Order total','Sale Price','Amount']),
      date:pickDate(row,['Paid On Date','Sale Date','Date Sold','Sold On','Order date','Paid Date','Date'])
    })).filter(x=>x.total!=null && x.date!=null);
    const all=store.all(); all.sales=sales; store.set('sales',all.sales);
    normalizeExpensesInPlace();
    toast(`Imported ${sales.length} sales from CSV`); tryRenderAll(); activateView('view-home');
  };
  r.readAsText(file);
}
$('#btnImportEbay').addEventListener('click',()=>$('#ebayCsv').click());
$('#ebayCsv').addEventListener('change',e=>{const f=e.target.files?.[0]; if(f) importEbayCsv(f);});
$('#btnExport').addEventListener('click',()=>{
  const blob=new Blob([JSON.stringify(store.all(),null,2)],{type:'application/json'});
  const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=`scale-flipz-backup-${Date.now()}.json`;
  a.click(); URL.revokeObjectURL(a.href);
});
$('#backupFile').addEventListener('change',e=>{
  const f=e.target.files?.[0]; if(!f)return; const r=new FileReader();
  r.onload=()=>{try{const o=JSON.parse(r.result);
    ['items','expenses','stores','sales','settings','supplies'].forEach(k=>{if(o[k]) store.set(k,o[k]);});
    normalizeExpensesInPlace();
    toast('Backup imported'); tryRenderAll();
  }catch{toast('Invalid backup file','bad');}};
  r.readAsText(f);
});

/* ================= EBAY SYNC TOOLBAR (optional) ================= */
function injectEbayControls() {
  if (document.getElementById('ebay-sync-toolbar')) return;
  const bar=document.createElement('div');
  bar.id='ebay-sync-toolbar';
  bar.style.cssText=['position:relative','margin:12px 0','padding:8px','border:1px solid var(--line)','background:var(--card)','border-radius:12px','display:flex','gap:8px','flex-wrap:wrap','align-items:center'].join(';');
  const title=document.createElement('strong'); title.textContent='eBay Sync'; title.style.marginRight='8px'; bar.appendChild(title);
  const connect=document.createElement('a'); connect.href=BACKEND_URL + '/auth/start'; connect.target='_blank'; connect.rel='noopener'; connect.textContent='Connect eBay'; connect.className='btn'; bar.appendChild(connect);
  const btnSync=document.createElement('button'); btnSync.textContent='Sync Now'; btnSync.onclick=async()=>{try{await fetch(BACKEND_URL+'/sync-now');}catch{}; tryRenderAll();}; btnSync.className='btn'; bar.appendChild(btnSync);
  const main=document.querySelector('main')||document.body; main.insertBefore(bar, main.firstChild);
}
function updateToolbarVisibility() {
  const s = getSettings();
  const sales = readArrLS('tt-sales'); const exps = readArrLS('tt-expenses');
  const hasData = (Array.isArray(sales)&&sales.length>0) || (Array.isArray(exps)&&exps.length>0);
  const shouldShow = (s.flags?.showToolbar === true) || !hasData;
  const bar = document.getElementById('ebay-sync-toolbar');
  if (shouldShow) { if (!bar) injectEbayControls(); else bar.style.display = ''; }
  else { if (bar) bar.remove(); }
}

/* ================= RENDER / BOOTSTRAP ================= */
function tryRenderAll(){ safe(renderTotalSales); safe(renderSalesChart); safe(renderExpensePie); safe(renderStoresPerf); safe(renderInventory); safe(renderRoutes); safe(renderSupplies); safe(renderExpenses); }

document.addEventListener('DOMContentLoaded', () => {
  normalizeExpensesInPlace();   // clean categories/labels on boot
  tryRenderAll();
});
window.addEventListener('load', () => { renderTotalSales(); });

</script>

<!-- PWA (optional) -->
<script>
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('sw.js?v=tt-v8-2025-08-16a').catch(()=>{});
}
</script>
</body>
</html>
