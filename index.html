
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Thrift Tracker</title>

  <!-- PWA + iOS full-screen -->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="theme-color" content="#0b0f14">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Thrift Tracker">
  <link rel="manifest" href="manifest.webmanifest">
  <link rel="apple-touch-icon" href="icon-192.png">
  <link rel="icon" href="icon-192.png">

  <style>
    :root{--bg:#0b0f14;--card:#111924;--ink:#dbe7ff;--muted:#8aa0c7;--accent:#5bbcff;--ok:#34d399;--warn:#fbbf24;--bad:#ef4444}
    html,body{height:100%}
    body{margin:0;background:linear-gradient(180deg,#071019,#0b0f14 30%,#0b0f14);color:var(--ink);font:15px/1.4 system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;-webkit-font-smoothing:antialiased}
    header{position:sticky;top:0;background:#0b0f14cc;backdrop-filter:saturate(180%) blur(10px);border-bottom:1px solid #1f2a3a;z-index:5}
    .wrap{max-width:980px;margin:0 auto;padding:16px}
    h1{margin:6px 0 0;font-size:20px;letter-spacing:.3px}
    .tabs{display:flex;gap:8px;margin:12px 0 0;flex-wrap:wrap}
    .tabs button{appearance:none;border:1px solid #1f2a3a;background:var(--card);color:var(--ink);padding:8px 12px;border-radius:10px;cursor:pointer}
    .tabs button[aria-selected="true"], .tabs button:hover{border-color:var(--accent);box-shadow:0 0 0 2px #5bbcff20}
    main{padding:16px}
    section.tab{display:none}
    section.tab.active{display:block}
    .card{background:var(--card);border:1px solid #1f2a3a;border-radius:14px;padding:14px;margin:12px 0}
    label{display:flex;flex-direction:column;gap:6px;margin:8px 0;font-size:13px;color:var(--muted)}
    input,select,textarea{background:#0e1622;border:1px solid #223146;color:var(--ink);padding:10px;border-radius:10px;outline:none}
    input:focus,textarea:focus{border-color:var(--accent);box-shadow:0 0 0 2px #5bbcff20}
    .row{display:flex;gap:12px;flex-wrap:wrap}
    .row > *{flex:1 1 260px}
    .btn{appearance:none;background:#123048;border:1px solid #244e72;color:var(--ink);padding:10px 12px;border-radius:12px;cursor:pointer}
    .btn.primary{background:#0f2740;border-color:#285a85}
    .btn.good{border-color:#1b6f52}
    .btn.warn{border-color:#6d530f}
    .btn:disabled{opacity:.6;cursor:not-allowed}
    ul{list-style:none;padding:0;margin:0}
    li{padding:10px;border-bottom:1px solid #1f2a3a}
    small.helper{color:var(--muted)}
    .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:12px}
    .pill{display:inline-block;padding:3px 8px;border-radius:999px;background:#0e1622;border:1px solid #1f2a3a;color:var(--muted);font-size:12px}
  </style>
</head>
<body>
  <header>
    <div class="wrap">
      <h1>ðŸ›’ Thrift Tracker</h1>
      <div class="tabs" role="tablist" aria-label="Sections">
        <button id="nav-dash" role="tab" aria-controls="tab-dash" aria-selected="true">Dashboard</button>
        <button id="nav-log" role="tab" aria-controls="tab-log">Log Item</button>
        <button id="nav-settings" role="tab" aria-controls="tab-settings">Supplies & Settings</button>
      </div>
    </div>
  </header>

  <main class="wrap">
    <!-- DASHBOARD -->
    <section id="tab-dash" class="tab active" aria-labelledby="nav-dash">
      <div class="card">
        <h2>Today</h2>
        <div class="grid" id="todayStats">
          <div class="card"><div class="pill">Items</div><h3 id="stat-items">0</h3></div>
          <div class="card"><div class="pill">Spend</div><h3 id="stat-spend">$0.00</h3></div>
          <div class="card"><div class="pill">Avg Buy</div><h3 id="stat-avg">$0.00</h3></div>
        </div>
      </div>
      <div class="card">
        <h3>Quick Links</h3>
        <div class="row">
          <button class="btn" id="btnOpenGuide">Open Apple Maps Guide</button>
          <a class="btn" id="btnOpenBackend" href="#" target="_blank" rel="noopener">Open Backend (exec)</a>
        </div>
        <small class="helper">These use the URLs you save under Settings.</small>
      </div>
    </section>

    <!-- LOG ITEM -->
    <section id="tab-log" class="tab" aria-labelledby="nav-log">
      <form id="logForm" class="card">
        <h2>Log a Find</h2>
        <div class="row">
          <label> Date
            <input type="date" name="date" required>
          </label>
          <label> Store
            <input type="text" name="store" placeholder="Goodwill Outlet" required>
          </label>
          <label> Category
            <select name="category">
              <option>Electronics</option>
              <option>Shoes</option>
              <option>Appliances</option>
              <option>Toys</option>
              <option>Other</option>
            </select>
          </label>
        </div>
        <div class="row">
          <label> Item
            <input type="text" name="item" placeholder="Sony DVD player" required>
          </label>
          <label> Price (buy)
            <input type="number" step="0.01" name="price" placeholder="4.99" required>
          </label>
          <label> Qty
            <input type="number" name="qty" value="1" min="1" required>
          </label>
        </div>
        <label> Notes
          <textarea name="notes" rows="2" placeholder="Condition, model, comps..."></textarea>
        </label>
        <div class="row">
          <button class="btn primary" type="submit">Save to Sheet</button>
          <button class="btn" type="button" id="btnTestPost">Test Post</button>
        </div>
        <small class="helper">Posts to your Google Apps Script Web App (exec URL) you configure in Settings.</small>
      </form>
      <ul id="recentList" class="card"></ul>
    </section>

    <!-- SETTINGS -->
    <section id="tab-settings" class="tab" aria-labelledby="nav-settings">
      <div class="card">
        <h2>Connections</h2>
        <div class="row">
          <label> Backend URL (Apps Script exec)
            <input type="url" id="backendUrl" placeholder="https://script.google.com/.../exec">
          </label>
          <label> Apple Maps Guide URL
            <input type="url" id="appleMapsUrl" placeholder="https://maps.apple.com/guides?...">
          </label>
        </div>
        <div class="row">
          <button class="btn good" id="btnSaveSettings">Save Settings</button>
          <button class="btn warn" id="btnClearSettings">Clear</button>
        </div>
        <small class="helper">Saved locally on this device using localStorage.</small>
      </div>

      <div class="card">
        <h3>Supplies</h3>
        <form id="suppliesForm">
          <div class="row">
            <label>Supply Name
              <input type="text" name="name" placeholder="4x6 Labels" required>
            </label>
            <label>Link (prefer eBay)
              <input type="url" name="url" placeholder="https://www.ebay.com/itm/...">
            </label>
          </div>
          <button class="btn" type="submit">Save Link</button>
        </form>
        <ul id="suppliesList"></ul>
      </div>
    </section>
  </main>

  <!-- Inline scripts live at the END of <body>. This is where to place JS. -->
  <script>
  // ===== Simple state helpers =====
  const $ = (sel, root=document) => root.querySelector(sel);
  const $$ = (sel, root=document) => [...root.querySelectorAll(sel)];
  const storage = {
    get: (k, d=null) => { try { return JSON.parse(localStorage.getItem(k)) ?? d } catch { return d } },
    set: (k, v) => localStorage.setItem(k, JSON.stringify(v)),
    del: (k) => localStorage.removeItem(k)
  };

  // ===== Tabs =====
  $$('#nav-dash, #nav-log, #nav-settings').forEach(btn => {
    btn.addEventListener('click', () => selectTab(btn.id.replace('nav-', '')))
  });
  function selectTab(id){
    $$('.tab').forEach(s => s.classList.remove('active'));
    $$('#nav-dash, #nav-log, #nav-settings').forEach(b => b.setAttribute('aria-selected','false'));
    $('#tab-' + id).classList.add('active');
    $('#nav-' + id).setAttribute('aria-selected','true');
  }

  // ===== Settings (Backend URL & Apple Maps Guide) =====
  const backendInput = $('#backendUrl');
  const guideInput = $('#appleMapsUrl');
  const btnOpenBackend = $('#btnOpenBackend');
  const btnOpenGuide = $('#btnOpenGuide');

  function loadSettings(){
    const backendUrl = storage.get('backendUrl','');
    const guideUrl = storage.get('appleMapsGuideUrl','');
    backendInput.value = backendUrl || '';
    guideInput.value = guideUrl || '';
    btnOpenBackend.href = backendUrl || '#';
    btnOpenBackend.target = backendUrl ? '_blank' : '';
    btnOpenBackend.rel = backendUrl ? 'noopener' : '';
    btnOpenGuide.disabled = !guideUrl;
  }
  function saveSettings(){
    storage.set('backendUrl', backendInput.value.trim());
    storage.set('appleMapsGuideUrl', guideInput.value.trim());
    loadSettings();
    toast('Settings saved');
  }
  function clearSettings(){
    storage.del('backendUrl');
    storage.del('appleMapsGuideUrl');
    loadSettings();
    toast('Settings cleared');
  }
  $('#btnSaveSettings').addEventListener('click', saveSettings);
  $('#btnClearSettings').addEventListener('click', clearSettings);

  btnOpenGuide.addEventListener('click', () => {
    const url = storage.get('appleMapsGuideUrl');
    if(!url){ toast('No Apple Maps guide URL saved'); return }
    // If the URL is the raw "maps.apple.com/guides?..." link, just open it.
    // iOS will deep-link into Apple Maps; desktop will open the web page.
    window.open(url, '_blank');
  });

  // ===== Supplies list (local only) =====
  const suppliesForm = $('#suppliesForm');
  const suppliesList = $('#suppliesList');
  suppliesForm.addEventListener('submit', (e) => {
    e.preventDefault();
    const fd = new FormData(suppliesForm);
    const item = { name: fd.get('name'), url: fd.get('url') };
    const list = storage.get('supplies', []);
    list.push(item);
    storage.set('supplies', list);
    suppliesForm.reset();
    renderSupplies();
  });
  function renderSupplies(){
    const list = storage.get('supplies', []);
    suppliesList.innerHTML = list.map((x,i)=>`<li>
      <div style="display:flex;justify-content:space-between;gap:12px;align-items:center;">
        <div><strong>${x.name}</strong><br><a href="${x.url}" target="_blank" rel="noopener">${x.url || ''}</a></div>
        <button class="btn" data-del="${i}">Delete</button>
      </div>
    </li>`).join('');
    suppliesList.querySelectorAll('button[data-del]').forEach(b => b.addEventListener('click', () => {
      const idx = +b.getAttribute('data-del');
      const list = storage.get('supplies', []);
      list.splice(idx,1);
      storage.set('supplies', list);
      renderSupplies();
    }));
  }

  // ===== Log form -> Apps Script (exec) =====
  const logForm = $('#logForm');
  const recentList = $('#recentList');
  logForm.date.valueAsDate = new Date();

  async function postToBackend(payload){
    const url = storage.get('backendUrl');
    if(!url) throw new Error('Missing backend exec URL in Settings');
    const body = new URLSearchParams(payload);
    const res = await fetch(url, { method:'POST', headers:{'Content-Type':'application/x-www-form-urlencoded'}, body });
    if(!res.ok) throw new Error(`Backend error ${res.status}`);
    return res.json().catch(()=>({ ok:true }));
  }

  logForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    const fd = new FormData(logForm);
    const payload = Object.fromEntries(fd.entries());
    try{
      const r = await postToBackend({
        date: payload.date,
        store: payload.store,
        category: payload.category,
        item: payload.item,
        price: payload.price,
        qty: payload.qty,
        notes: payload.notes
      });
      addRecent(payload);
      updateStats();
      toast(r && r.message ? r.message : 'Saved');
      logForm.reset();
      logForm.date.valueAsDate = new Date();
    }catch(err){
      toast(err.message || 'Failed to save', 'bad');
    }
  });

  $('#btnTestPost').addEventListener('click', async () => {
    const today = new Date().toISOString().slice(0,10);
    try{
      const r = await postToBackend({
        date: today,
        store: 'Test Store',
        category: 'Electronics',
        item: 'Test Item',
        price: '1.23',
        qty: '1',
        notes: 'from app test button'
      });
      addRecent({date:today,store:'Test Store',category:'Electronics',item:'Test Item',price:'1.23',qty:'1',notes:'from app test button'});
      updateStats();
      toast('Test post OK');
    }catch(err){
      toast(err.message || 'Test failed', 'bad');
    }
  });

  function addRecent(entry){
    const key = 'recentPosts';
    const list = storage.get(key, []);
    list.unshift({ ...entry, ts: Date.now() });
    storage.set(key, list.slice(0,20));
    renderRecent();
  }
  function renderRecent(){
    const list = storage.get('recentPosts', []);
    recentList.innerHTML = '<h3>Recent</h3>' + list.map(x=>`<li><strong>${x.item}</strong> â€” ${x.store} ($${Number(x.price).toFixed(2)})<br><small class="helper">${x.category} â€¢ ${x.date}</small></li>`).join('');
  }

  // ===== Stats (client-side only demo) =====
  function updateStats(){
    const list = storage.get('recentPosts', []);
    const today = new Date().toISOString().slice(0,10);
    const todays = list.filter(x=>x.date===today);
    const items = todays.reduce((n,x)=>n + Number(x.qty||0), 0);
    const spend = todays.reduce((s,x)=>s + Number(x.price||0)*(Number(x.qty||1)), 0);
    const avg = items ? spend/items : 0;
    $('#stat-items').textContent = items;
    $('#stat-spend').textContent = `$${spend.toFixed(2)}`;
    $('#stat-avg').textContent = `$${avg.toFixed(2)}`;
  }

  // ===== Tiny toast =====
  let toastTimer;
  function toast(msg, kind){
    clearTimeout(toastTimer);
    let el = $('#toast');
    if(!el){ el = document.createElement('div'); el.id='toast'; document.body.appendChild(el); }
    el.textContent = msg; el.style.cssText = `position:fixed;left:50%;bottom:24px;transform:translateX(-50%);background:${kind==='bad'? '#3a1016':'#0f2740'};border:1px solid #244e72;padding:10px 14px;border-radius:12px;z-index:1000`;
    toastTimer = setTimeout(()=>{ el.remove() }, 2200);
  }

  // ===== PWA service worker (optional) =====
  if('serviceWorker' in navigator){
    // Optional: register only if you have /sw.js present
    navigator.serviceWorker.register('/sw.js').catch(()=>{});
  }

  // ===== Init =====
  function init(){
    loadSettings();
    renderSupplies();
    renderRecent();
    updateStats();
  }
  init();
  </script>
</body>
</html>
</script>
</body>
</html>
